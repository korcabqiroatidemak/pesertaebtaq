<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>CODE X – Cetak Kartu Peserta</title>

<style>
/* ================= PAGE SETUP ================= */
@page{
    size:215mm 330mm;
    margin:10mm;
}
body{
    margin:0;
    background:#eee;
    font-family:"Times New Roman", Times, serif;
}

/* ================= CONTROL PANEL ================= */
#control-panel{
    background:#fff;
    max-width:900px;
    margin:10px auto;
    padding:12px;
    border:1px solid #ccc;
}
#control-panel h3{
    margin:0 0 6px 0;
}
#shift-container{
    border:1px solid #ddd;
    padding:10px;
    display:grid;
    grid-template-rows:repeat(3, auto); /* 3 BARIS */
    grid-auto-flow:column;
    gap:8px 30px;
    max-height:90px;
    overflow-x:auto;
}
#control-panel button{
    margin-top:10px;
    padding:6px 14px;
    font-weight:bold;
}

/* ================= PAGE ================= */
.page{
    width:215mm;
    height:330mm;
    background:#fff;
    margin:10px auto;
    padding:6mm;
    box-sizing:border-box;
    display:flex;
    flex-direction:column;

    page-break-after:always;
    break-after:page;
}

/* ================= HEADER ================= */
.header{
    text-align:center;
    border-bottom:2px solid #000;
    padding-bottom:6px;
    margin-bottom:6px;
}
.header h2{
    margin:0;
    font-size:14pt;
}
.header .sub{
    font-size:11pt;
}

/* ================= GRID ================= */
.grid{
    flex:1;
    display:grid;
    gap:6px;
}
.first .grid{
    grid-template-columns:1fr 1fr;
    grid-template-rows:repeat(5, 1fr); /* 2×5 */
}
.next .grid{
    grid-template-columns:1fr 1fr;
    grid-template-rows:repeat(6, 1fr); /* 2×6 */
}

/* ================= CARD ================= */
.card{
    border:1px solid #000;
    padding:5px;
    display:flex;
    font-size:10pt;
}
.photo{
    width:3cm;
    height:4cm;
    border:1px solid #ccc;
    margin-right:6px;
    flex-shrink:0;
}
.photo img{
    width:100%;
    height:100%;
    object-fit:cover;
}
.info{
    flex:1;
}
.row{
    display:flex;
    margin-bottom:2px;
}
.label{
    width:65px;
    font-weight:bold;
}
.sep{
    width:8px;
}
.val{
    flex:1;
}

/* ================= FOOTER ================= */
.next{
    position:relative;
}
.footer{
    position:absolute;
    bottom:6mm;
    right:8mm;
    font-size:9pt;
    color:#555;
}

/* ================= PRINT ================= */
@media print{
    body{background:#fff;}
    #control-panel{display:none;}
}
</style>
</head>

<body>

<!-- ========== PANEL KONTROL ========== -->
<div id="control-panel">
    <h3>Pilih Gelombang – Shift</h3>

    <label>
        <input type="checkbox" id="checkAll"> <b>Pilih Semua</b>
    </label>

    <div id="shift-container"></div>

    <button onclick="generate()">GENERATE</button>
</div>

<div id="output"></div>

<script>
/* ================= DATA SOURCE ================= */
const SHEET_ID = '1eIcvIgCLWG3F9jQdsw5XN9llOsK2PoYWKUg1qaQJyyA';
const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Biodata Cek`;

let rawData=[];

/* ================= FETCH ================= */
fetch(SHEET_URL)
.then(r=>r.text())
.then(csv=>{
    const rows=csv.trim().split('\n');
    const headers=rows[0].split(',').map(h=>h.replace(/"/g,''));
    for(let i=1;i<rows.length;i++){
        const cols=rows[i].match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g)||[];
        let obj={};
        headers.forEach((h,idx)=>{
            obj[h]=cols[idx]?cols[idx].replace(/"/g,''):'';
        });
        rawData.push(obj);
    }
    buildShiftPanel();
});

/* ================= PANEL ================= */
function buildShiftPanel(){
    const box=document.getElementById('shift-container');
    const set=new Set();

    rawData.forEach(d=>{
        if(d.Gelombang && d.Shift){
            set.add(`${d.Gelombang}-${d.Shift}`);
        }
    });

    [...set].sort().forEach(v=>{
        const lbl=document.createElement('label');
        lbl.innerHTML=`<input type="checkbox" value="${v}"> Gel ${v.replace('-', ' - Shift ')}`;
        box.appendChild(lbl);
    });

    document.getElementById('checkAll').addEventListener('change',e=>{
        document.querySelectorAll('#shift-container input')
        .forEach(cb=>cb.checked=e.target.checked);
    });
}

/* ================= GENERATE ================= */
function generate(){
    const output=document.getElementById('output');
    output.innerHTML='';

    document.querySelectorAll('#shift-container input:checked')
    .forEach(cb=>{
        const [gel,shift]=cb.value.split('-');
        const data=rawData
            .filter(d=>d.Gelombang==gel && d.Shift==shift)
            .sort((a,b)=>Number(a.Nomor)-Number(b.Nomor));

        renderShift(output,data,gel,shift);
    });
}

/* ================= RENDER SHIFT ================= */
function renderShift(output,data,gel,shift){
    if(!data.length) return;

    let page=createFirstPage(gel,shift);
    let count=0;

    data.forEach(d=>{
        const limit = page.classList.contains('first') ? 10 : 12;
        if(count===limit){
            output.appendChild(page);
            page=createNextPage(gel,shift);
            count=0;
        }
        page.querySelector('.grid').appendChild(createCard(d));
        count++;
    });

    output.appendChild(page);
}

/* ================= PAGE ================= */
function createFirstPage(gel,shift){
    const p=document.createElement('div');
    p.className='page first';
    p.innerHTML=`
        <div class="header">
            <h2>DAFTAR PESERTA</h2>
            <div class="sub">Rojab 1447 | Gel ${gel} - Shift ${shift}</div>
        </div>
        <div class="grid"></div>
    `;
    return p;
}

function createNextPage(gel,shift){
    const p=document.createElement('div');
    p.className='page next';
    p.innerHTML=`
        <div class="grid"></div>
        <div class="footer">Rojab 1447 | Gel ${gel} - Shift ${shift}</div>
    `;
    return p;
}

/* ================= CARD ================= */
function createCard(d){
    const c=document.createElement('div');
    c.className='card';

    const no=String(d.Nomor||'').padStart(3,'0');
    const foto=d['Kirim Pas Foto Ukuran PostCard']||'';

    c.innerHTML=`
        <div class="photo">
            <img src="${foto}" onerror="this.style.display='none'">
        </div>
        <div class="info">
            <div class="row"><span class="label">Nomor</span><span class="sep">:</span><span class="val">${no}</span></div>
            <div class="row"><span class="label">Nama</span><span class="sep">:</span><span class="val"><b>${(d['Nama Lengkap (Sesuai Akta)']||'').toUpperCase()}</b></span></div>
            <div class="row"><span class="label">TTL</span><span class="sep">:</span><span class="val">${d['Tempat Lahir']||''}, ${d['Tanggal Lahir']||''}</span></div>
            <div class="row"><span class="label">JK</span><span class="sep">:</span><span class="val">${d['Jenis Kelamin']||''}</span></div>
            <div class="row"><span class="label">BIN</span><span class="sep">:</span><span class="val">${(d['Nama Ayah']||'').toUpperCase()}</span></div>
            <div class="row"><span class="label">BINTI</span><span class="sep">:</span><span class="val">${(d['Nama Ibu']||'').toUpperCase()}</span></div>
        </div>
    `;
    return c;
}
</script>

</body>
</html>
