<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cetak Biodata Peserta EBTAQ</title>
    <style>
        /* ================================================= */
        /* 1. Pengaturan Halaman Cetak (Print Styles) */
        /* ================================================= */
        body {
            font-family: 'Times New Roman', Times, serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }
        /* Kontainer Utama Dokumen (Meniru Kertas A4) */
        .kartu-biodata {
            background-color: white;
            border: 1px solid #aaa;
            width: 21cm; 
            min-height: 29.7cm; 
            margin: 20px auto;
            padding: 1.5cm 2cm;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.1);
            box-sizing: border-box;
            page-break-after: always;
        }
        
        /* ================================================= */
        /* 2. Layout dan Konten */
        /* ================================================= */
        .header {
            text-align: center;
            border-bottom: 2px solid #000;
            padding-bottom: 5px;
            margin-bottom: 20px;
        }
        .header h2 {
            margin: 0;
            font-size: 14pt;
        }
        .header p {
            margin: 2px 0 0;
            font-size: 10pt;
        }

        .data-grid {
            display: grid;
            grid-template-columns: 150px 1fr 100px; 
            gap: 5px 20px;
            align-items: start;
            font-size: 12pt;
        }
        .label {
            font-weight: bold;
            grid-column: 1;
        }
        .value {
            grid-column: 2;
        }
        .foto-container {
            grid-column: 3;
            grid-row: 1 / span 8;
            text-align: center;
            border: 1px solid #000;
            padding: 5px;
        }
        .foto-container img {
            width: 100%; 
            height: auto;
            max-width: 90px;
            display: block;
            margin: 0 auto;
        }
        .foto-label {
            font-size: 8pt;
            margin-top: 5px;
        }
        .ttd-area {
            margin-top: 50px;
            display: flex;
            justify-content: flex-end;
            font-size: 11pt;
            text-align: center;
        }
        .ttd-area div {
            width: 40%;
        }
        .ttd-placeholder {
            border-bottom: 1px dashed #000;
            height: 20px;
            margin-top: 50px;
        }

        /* ================================================= */
        /* 3. Media Print (Kualitas Cetak) */
        /* ================================================= */
        @media print {
            body {
                background-color: white;
                padding: 0;
            }
            .kartu-biodata {
                box-shadow: none;
                margin: 0;
                border: none;
                min-height: auto;
            }
            #loading {
                display: none;
            }
        }
    </style>
</head>
<body>

    <div id="loading" style="text-align: center; margin-top: 50px;">Memuat data dari Google Sheet. Mohon tunggu...</div>
    <div id="container-biodata"></div>

    <script>
        // ID Spreadsheet Anda
        const SHEET_ID = '1eIcvIgCLWG3F9jQdsw5XN9llOsK2PoYWKUg1qaQJyyA';
        const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Form Responses 1`; 
        
        const container = document.getElementById('container-biodata');
        const loading = document.getElementById('loading');

        // 1. Fungsi Mengambil Data
        async function fetchSheetData() {
            try {
                const response = await fetch(SHEET_URL);
                if (!response.ok) {
                    throw new Error(`Gagal mengambil data. Status: ${response.status}`);
                }
                const csvText = await response.text();
                loading.style.display = 'none';
                processCSV(csvText);
            } catch (error) {
                loading.innerText = '‼️ Error: ' + error.message;
                console.error(error);
            }
        }

        // 2. Helper: Ubah URL Google Drive ke Direct Link
        function getDirectDriveUrl(url) {
            if (!url) return '';
            // Mencari ID file dari pola "id=..."
            const matchId = url.match(/id=([a-zA-Z0-9_-]+)/);
            // Jika ID ditemukan, ubah ke format lh3.googleusercontent
            if (matchId && matchId[1]) {
                return `https://lh3.googleusercontent.com/d/${matchId[1]}`;
            }
            return url;
        }

        // 3. Fungsi Parse CSV
        function processCSV(csvText) {
            const rows = csvText.trim().split('\n').filter(row => row.trim().length > 0);
            if (rows.length < 2) {
                container.innerHTML = '<p style="text-align:center;">Data kosong.</p>';
                return;
            }

            const headers = rows[0].split(',').map(header => header.trim().replace(/"/g, ''));
            
            for (let i = 1; i < rows.length; i++) {
                const rowData = rows[i].match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || []; 
                let participant = {};
                rowData.forEach((value, index) => {
                    participant[headers[index]] = value ? value.trim().replace(/"/g, '') : '';
                });
                participant['NO'] = i + 1; 
                createBiodataCard(participant);
            }
        }

        // 4. Fungsi Render Kartu (HTML)
        function createBiodataCard(data) {
            const kartu = document.createElement('div');
            kartu.className = 'kartu-biodata';

            // Variabel Data
            const NAMA = data['Nama Lengkap (Sesuai Akta)'] || '-';
            const ABSEN = data['ID Pendaftaran'] || '-';
            const LEMBAGA = data['Asal Lembaga / TPQ'] || '-';
            const TEMPAT = data['Tempat Lahir'] || '';
            const TGL = data['Tanggal Lahir'] || '';
            const TTL_LENGKAP = (TEMPAT && TGL) ? `${TEMPAT}, ${TGL}` : '-';
            const BIN = data['Nama Ayah'] || '-';
            const BINTI = data['Nama Ibu'] || '-';
            const JK = data['Jenis Kelamin'] || '-';
            
            // LOGIKA FOTO BARU
            const rawFotoUrl = data['Kirim Pas Foto Ukuran PostCard'] || '';
            const FOTO_URL = getDirectDriveUrl(rawFotoUrl);

            // Header
            kartu.innerHTML = `
                <div class="header">
                    <h2>KARTU BIODATA PESERTA EBTAQ</h2>
                    <p>ASAL LEMBAGA: ${LEMBAGA.toUpperCase()}</p>
                </div>
            `;

            // Data Grid
            const grid = document.createElement('div');
            grid.className = 'data-grid';
            
            const dataFields = [
                { label: 'NO.', value: data['NO'] }, 
                { label: 'NO. ABSEN', value: ABSEN }, 
                { label: 'NAMA LENGKAP', value: NAMA.toUpperCase() }, 
                { label: 'T.T.L.', value: TTL_LENGKAP }, 
                { label: 'JENIS KELAMIN', value: JK }, 
                { label: 'BIN', value: BIN.toUpperCase() }, 
                { label: 'BINTI', value: BINTI.toUpperCase() }, 
            ];

            dataFields.forEach(field => {
                grid.innerHTML += `<span class="label">${field.label}</span><span class="value">: ${field.value}</span>`;
            });
            
            // Foto
            grid.innerHTML += `
                <div class="foto-container">
                    <img src="${FOTO_URL}" alt="Foto Peserta" 
                         onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'100\\' height=\\'130\\'><rect width=\\'100\\'% height=\\'100\\'% fill=\\'#eee\\' stroke=\\'#aaa\\'/><text x=\\'50\\' y=\\'65\\' font-size=\\'10\\' text-anchor=\\'middle\\' fill=\\'#777\\'>FOTO GAGAL</text></svg>'"
                    >
                    <p class="foto-label">3x4</p>
                </div>
            `;

            kartu.appendChild(grid);
            
            // Tanda Tangan
            kartu.innerHTML += `
                <div class="ttd-area">
                    <div>
                        <p>Demak, ${new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}</p>
                        <p>Tanda Tangan Peserta</p>
                        <div class="ttd-placeholder"></div>
                        <p style="margin-top: 5px;">( ${NAMA.toUpperCase()} )</p>
                    </div>
                </div>
            `;

            container.appendChild(kartu);
        }

        // Jalankan Script
        fetchSheetData();
    </script>
</body>
</html>
