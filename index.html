<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cetak Kartu Peserta (Hemat Kertas)</title>
    <style>
        /* ================================================= */
        /* 1. Reset & Page Setup */
        /* ================================================= */
        @page {
            size: A4 portrait;
            margin: 1cm; /* Margin kertas */
        }
        body {
            font-family: 'Times New Roman', Times, serif;
            margin: 0;
            padding: 0;
            background-color: #eee;
        }

        /* ================================================= */
        /* 2. Container Halaman (Menampung 10 Kartu) */
        /* ================================================= */
        .page-container {
            background-color: white;
            width: 21cm;        /* Lebar A4 */
            height: 29.7cm;     /* Tinggi A4 */
            padding: 1cm;       /* Padding dalam agar tidak mepet tepi kertas */
            margin: 20px auto;  /* Jarak antar halaman di tampilan layar */
            box-sizing: border-box;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
            
            /* GRID SYSTEM: 2 Kolom x 5 Baris */
            display: grid;
            grid-template-columns: 1fr 1fr; 
            grid-template-rows: repeat(5, 1fr); 
            gap: 10px; /* Jarak antar kartu */
            
            page-break-after: always; /* Memaksa printer pindah kertas setelah container ini habis */
        }

        /* ================================================= */
        /* 3. Desain Kartu Mini */
        /* ================================================= */
        .kartu-mini {
            border: 1px solid #000;
            padding: 5px;
            display: flex; /* Flexbox untuk Data di Kiri, Foto di Kanan */
            overflow: hidden;
            font-size: 9pt; /* Font diperkecil agar muat */
        }

        /* Bagian Teks */
        .info-area {
            flex: 1; /* Mengambil sisa ruang */
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .row-data {
            display: flex;
            margin-bottom: 2px;
        }
        .label {
            width: 85px; /* Lebar kolom label */
            font-weight: bold;
            flex-shrink: 0;
        }
        .separator {
            width: 10px;
            text-align: center;
        }
        .value {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis; /* Titik-titik jika teks kepanjangan */
        }

        /* Bagian Foto */
        .foto-area {
            width: 3cm; /* Lebar area foto */
            margin-left: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-left: 1px dashed #ccc;
        }
        .foto-area img {
            max-width: 100%;
            max-height: 100%;
            height: auto;
            object-fit: contain;
        }

        /* ================================================= */
        /* 4. Mode Cetak */
        /* ================================================= */
        @media print {
            body { background-color: white; }
            .page-container {
                margin: 0;
                box-shadow: none;
                border: none;
                height: 100vh; /* Pastikan full height */
            }
            #loading { display: none; }
        }
    </style>
</head>
<body>

    <div id="loading" style="text-align: center; margin-top: 50px;">Memuat data...</div>
    
    <div id="main-output"></div>

    <script>
        const SHEET_ID = '1eIcvIgCLWG3F9jQdsw5XN9llOsK2PoYWKUg1qaQJyyA';
        const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Form Responses 1`; 
        
        const mainOutput = document.getElementById('main-output');
        const loading = document.getElementById('loading');

        // --- Helper: Direct Link Google Drive ---
        function getDirectDriveUrl(url) {
            if (!url) return '';
            const matchId = url.match(/id=([a-zA-Z0-9_-]+)/);
            if (matchId && matchId[1]) return `https://lh3.googleusercontent.com/d/${matchId[1]}`;
            return url;
        }

        // --- Fetch Data ---
        async function fetchSheetData() {
            try {
                const response = await fetch(SHEET_URL);
                if (!response.ok) throw new Error("Gagal ambil data");
                const csvText = await response.text();
                loading.style.display = 'none';
                processCSV(csvText);
            } catch (error) {
                loading.innerText = 'Error: ' + error.message;
            }
        }

        // --- Process CSV & Pagination Logic ---
        function processCSV(csvText) {
            const rows = csvText.trim().split('\n').filter(r => r.trim().length > 0);
            if (rows.length < 2) return;

            const headers = rows[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const allParticipants = [];

            // 1. Parsing semua data dulu ke dalam Array Object
            for (let i = 1; i < rows.length; i++) {
                const rowData = rows[i].match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
                let p = { 'NO': i + 1 };
                rowData.forEach((val, idx) => {
                    p[headers[idx]] = val ? val.trim().replace(/"/g, '') : '';
                });
                allParticipants.push(p);
            }

            // 2. Logic Pagination (Per 10 Item)
            const ITEMS_PER_PAGE = 10;
            let currentPageDiv = createNewPage();

            allParticipants.forEach((data, index) => {
                // Jika halaman sudah penuh (10 item), buat halaman baru
                if (index > 0 && index % ITEMS_PER_PAGE === 0) {
                    mainOutput.appendChild(currentPageDiv); // Simpan halaman lama
                    currentPageDiv = createNewPage();       // Bikin halaman baru
                }
                
                // Masukkan kartu ke halaman yang sedang aktif
                const cardHTML = createCardHTML(data);
                currentPageDiv.appendChild(cardHTML);
            });

            // Simpan halaman terakhir jika masih ada isinya
            if (currentPageDiv.hasChildNodes()) {
                mainOutput.appendChild(currentPageDiv);
            }
        }

        // --- Membuat Elemen Halaman Kertas A4 ---
        function createNewPage() {
            const div = document.createElement('div');
            div.className = 'page-container';
            return div;
        }

        // --- Membuat Elemen Kartu Mini (HTML) ---
        function createCardHTML(data) {
            const card = document.createElement('div');
            card.className = 'kartu-mini';

            // Variabel Data
            const NAMA = (data['Nama Lengkap (Sesuai Akta)'] || '-').toUpperCase();
            const ABSEN = data['ID Pendaftaran'] || '-';
            const LEMBAGA = (data['Asal Lembaga / TPQ'] || '-').toUpperCase();
            const TTL = (data['Tempat Lahir'] || '') + ', ' + (data['Tanggal Lahir'] || '');
            const BIN = (data['Nama Ayah'] || '-').toUpperCase();
            const JK = data['Jenis Kelamin'] || '-';
            
            const rawFoto = data['Kirim Pas Foto Ukuran PostCard'] || '';
            const FOTO_URL = getDirectDriveUrl(rawFoto);

            // Template HTML Kartu
            card.innerHTML = `
                <div class="info-area">
                    <div class="row-data">
                        <span class="label">NO. ABSEN</span><span class="separator">:</span>
                        <span class="value">${ABSEN}</span>
                    </div>
                    <div class="row-data">
                        <span class="label">NAMA</span><span class="separator">:</span>
                        <span class="value" style="font-weight:bold;">${NAMA}</span>
                    </div>
                    <div class="row-data">
                        <span class="label">LEMBAGA</span><span class="separator">:</span>
                        <span class="value">${LEMBAGA}</span>
                    </div>
                    <div class="row-data">
                        <span class="label">TTL</span><span class="separator">:</span>
                        <span class="value">${TTL}</span>
                    </div>
                    <div class="row-data">
                        <span class="label">JENIS KELAMIN</span><span class="separator">:</span>
                        <span class="value">${JK}</span>
                    </div>
                    <div class="row-data">
                        <span class="label">BIN/BINTI</span><span class="separator">:</span>
                        <span class="value">${BIN}</span>
                    </div>
                </div>
                <div class="foto-area">
                     <img src="${FOTO_URL}" 
                          onerror="this.style.display='none'; this.parentNode.innerText='FOTO N/A'"
                     >
                </div>
            `;
            return card;
        }

        fetchSheetData();
    </script>
</body>
</html>
