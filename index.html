<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>CODE X – Cetak Kartu Peserta EBTAQ</title>

<style>
/* ================================================= */
/* GLOBAL & PRINT SETUP (F4)                         */
/* ================================================= */
@page { size: 215mm 330mm; margin: 0; }

body{
    font-family: "Times New Roman", serif;
    background:#525659;
    margin:0;
    padding:20px 0;
}

/* ================================================= */
/* CONTROL PANEL                                     */
/* ================================================= */
.control-panel{
    background:#fff;
    width:215mm;
    margin:auto;
    padding:20px 25px;
    border-radius:8px;
    box-shadow:0 4px 15px rgba(0,0,0,.3);
    margin-bottom:25px;
}

.control-panel h3{
    margin:0 0 10px 0;
    color:#007bff;
}

.row{
    display:flex;
    gap:15px;
    margin-bottom:15px;
}

.control-group{
    flex:1;
    display:flex;
    flex-direction:column;
    gap:5px;
}

label{
    font-size:12px;
    font-weight:bold;
    font-family:Arial,sans-serif;
}

input,select{
    padding:7px 10px;
    font-size:14px;
}

#shift-container{
    border:1px solid #ddd;
    padding:10px;
    display:grid;
    grid-template-rows:repeat(3,auto);
    grid-auto-flow:column;
    gap:8px 25px;
    overflow-x:auto;
}

.cb-item{
    font-family:Arial,sans-serif;
    font-size:13px;
    white-space:nowrap;
}

.btn-generate{
    width:100%;
    padding:12px;
    font-weight:bold;
    background:#28a745;
    color:#fff;
    border:none;
    cursor:pointer;
}

/* ================================================= */
/* PAGE CONTAINER                                    */
/* ================================================= */
.page{
    width:215mm;
    height:330mm;
    background:#fff;
    margin:auto;
    box-sizing:border-box;
    padding:10mm 15mm;
    page-break-after:always;
}

/* ================================================= */
/* HEADER (HALAMAN PERTAMA)                           */
/* ================================================= */
.kop{
    display:flex;
    align-items:center;
    justify-content:center;
    position:relative;
}
.logo{
    position:absolute;
    left:0;
    width:70px;
}
.logo img{ width:100%; }

.kop-text{
    text-align:center;
    padding:0 70px;
}
.kop-text .t1{font-size:12pt;font-weight:bold;}
.kop-text .t2{font-size:22pt;font-weight:900;}
.kop-text .t3{font-size:12pt;font-weight:bold;}

.double-line{
    border-top:4px solid #000;
    border-bottom:1px solid #000;
    height:2px;
    margin:8px 0 10px;
}

.info{
    display:flex;
    justify-content:space-between;
    font-weight:bold;
    font-size:11pt;
    margin-bottom:8px;
}

/* ================================================= */
/* GRID KARTU                                        */
/* ================================================= */
.grid-10{
    display:grid;
    grid-template-columns:1fr 1fr;
    grid-template-rows:repeat(5,1fr);
    gap:10px;
}
.grid-12{
    display:grid;
    grid-template-columns:1fr 1fr;
    grid-template-rows:repeat(6,1fr);
    gap:10px;
}

.kartu{
    border:1px solid #000;
    padding:5px;
    display:flex;
    font-size:10pt;
    line-height:1.2;
}

.foto{
    width:3cm;
    height:4cm;
    margin-right:8px;
    border:1px solid #ccc;
}
.foto img{
    width:100%;
    height:100%;
    object-fit:cover;
}

.info-kartu{
    flex:1;
}

.row-data{
    display:flex;
    margin-bottom:3px;
}
.label{
    width:60px;
    font-weight:bold;
}
.sep{ width:10px; text-align:center; }

@media print{
    body{background:none;padding:0;}
    .control-panel{display:none;}
}
</style>
</head>

<body>

<div class="control-panel">
    <h3>Panel Kontrol – CODE X</h3>
    <div class="row">
        <div class="control-group">
            <label>Judul</label>
            <input id="judul" value="Cetak Kartu Peserta EBTAQ">
        </div>
        <div class="control-group">
            <label>Bulan</label>
            <input id="bulan">
        </div>
        <div class="control-group">
            <label>Tahun</label>
            <input id="tahun">
        </div>
    </div>

    <label>Gelombang & Shift</label>
    <div id="shift-container">Memuat data…</div>

    <button class="btn-generate" onclick="generate()">GENERATE</button>
</div>

<div id="output"></div>

<script>
const SHEET_ID = "1eIcvIgCLWG3F9jQdsw5XN9llOsK2PoYWKUg1qaQJyyA";
const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Biodata Cek`;
const LOGO = "QIRAATI.png";

let rawData=[], grouped={};

function getFoto(url){
    const m=url?.match(/id=([a-zA-Z0-9_-]+)/);
    return m?`https://lh3.googleusercontent.com/d/${m[1]}`:'';
}

fetch(SHEET_URL).then(r=>r.text()).then(process);

function process(csv){
    const rows=csv.trim().split('\n');
    const headers=rows[0].split(',').map(h=>h.replace(/"/g,''));
    for(let i=1;i<rows.length;i++){
        const cols=rows[i].match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g)||[];
        let p={};
        cols.forEach((v,j)=>p[headers[j]]=v.replace(/"/g,''));
        p.INT_NO=parseInt(p.Nomor)||0;
        p.DISP_NO=String(p.Nomor||'').padStart(3,'0');
        const key=`${p.Gelombang}-${p.Shift}`;
        if(!grouped[key]) grouped[key]=[];
        grouped[key].push(p);
    }
    renderShift();
}

function renderShift(){
    const c=document.getElementById('shift-container');
    c.innerHTML='';
    Object.keys(grouped).sort().forEach(k=>{
        const [g,s]=k.split('-');
        const l=document.createElement('label');
        l.className='cb-item';
        l.innerHTML=`<input type="checkbox" value="${k}"> Gel ${g} Shift ${s} (${grouped[k].length})`;
        c.appendChild(l);
    });
}

function generate(){
    const out=document.getElementById('output');
    out.innerHTML='';
    const checked=[...document.querySelectorAll('#shift-container input:checked')];
    if(!checked.length){alert('Pilih shift!');return;}

    checked.forEach(cb=>{
        const data=grouped[cb.value].sort((a,b)=>a.INT_NO-b.INT_NO);
        let idx=0;

        /* HALAMAN PERTAMA */
        const page1=document.createElement('div');
        page1.className='page';
        page1.innerHTML=`
        <div class="kop">
            <div class="logo"><img src="${LOGO}"></div>
            <div class="kop-text">
                <div class="t1">KOORDINATOR PENDIDIKAN AL-QUR'AN</div>
                <div class="t2">METODE QIRAATI</div>
                <div class="t3">CABANG DEMAK</div>
            </div>
        </div>
        <div class="double-line"></div>
        <div class="info">
            <div>${document.getElementById('bulan').value} ${document.getElementById('tahun').value}</div>
            <div>Gel ${cb.value}</div>
        </div>
        <div class="grid-10"></div>`;
        const g10=page1.querySelector('.grid-10');
        for(let i=0;i<10 && idx<data.length;i++,idx++) g10.appendChild(card(data[idx]));
        out.appendChild(page1);

        /* HALAMAN LANJUTAN */
        while(idx<data.length){
            const p=document.createElement('div');
            p.className='page';
            const g=document.createElement('div');
            g.className='grid-12';
            for(let i=0;i<12 && idx<data.length;i++,idx++) g.appendChild(card(data[idx]));
            p.appendChild(g);
            out.appendChild(p);
        }
    });
}

function card(d){
    const c=document.createElement('div');
    c.className='kartu';
    c.innerHTML=`
    <div class="foto"><img src="${getFoto(d['Kirim Pas Foto Ukuran PostCard'])}"></div>
    <div class="info-kartu">
        <div class="row-data"><span class="label">Nomor</span><span class="sep">:</span>${d.DISP_NO}</div>
        <div class="row-data"><span class="label">Nama</span><span class="sep">:</span>${(d['Nama Lengkap (Sesuai Akta)']||'').toUpperCase()}</div>
        <div class="row-data"><span class="label">Lemb.</span><span class="sep">:</span>${(d['Asal Lembaga / TPQ']||'').toUpperCase()}</div>
    </div>`;
    return c;
}
</script>

</body>
</html>
