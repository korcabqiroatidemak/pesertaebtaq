<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cetak Biodata Peserta EBTAQ</title>
    <style>
        /* ================================================= */
        /* 1. Pengaturan Halaman Cetak (Print Styles) */
        /* ================================================= */
        body {
            font-family: 'Times New Roman', Times, serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }
        /* Kontainer Utama Dokumen (Meniru Kertas A4) */
        .kartu-biodata {
            background-color: white;
            border: 1px solid #aaa; /* Garis tepi untuk visual di layar */
            width: 21cm; 
            min-height: 29.7cm; 
            margin: 20px auto;
            padding: 1.5cm 2cm;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.1);
            box-sizing: border-box;
            page-break-after: always; /* MEMISAHKAN setiap kartu ke halaman baru saat dicetak */
        }
        
        /* ================================================= */
        /* 2. Layout dan Konten */
        /* ================================================= */
        .header {
            text-align: center;
            border-bottom: 2px solid #000;
            padding-bottom: 5px;
            margin-bottom: 20px;
        }
        .header h2 {
            margin: 0;
            font-size: 14pt;
        }
        .header p {
            margin: 2px 0 0;
            font-size: 10pt;
        }

        .data-grid {
            display: grid;
            /* Layout: Label (kecil), Nilai Data (besar), Foto (kecil) */
            grid-template-columns: 150px 1fr 100px; 
            gap: 5px 20px;
            align-items: start;
            font-size: 12pt;
        }
        .label {
            font-weight: bold;
            grid-column: 1; /* Kolom 1 untuk Label */
        }
        .value {
            grid-column: 2; /* Kolom 2 untuk Nilai */
        }
        .foto-container {
            grid-column: 3;
            grid-row: 1 / span 8; /* Rentang baris data */
            text-align: center;
            border: 1px solid #000; /* Border foto */
            padding: 5px;
        }
        .foto-container img {
            width: 100%; 
            height: auto;
            max-width: 90px;
            display: block;
            margin: 0 auto;
        }
        .foto-label {
            font-size: 8pt;
            margin-top: 5px;
        }
        .ttd-area {
            margin-top: 50px;
            display: flex;
            justify-content: flex-end;
            font-size: 11pt;
            text-align: center;
        }
        .ttd-area div {
            width: 40%;
        }
        .ttd-placeholder {
            border-bottom: 1px dashed #000;
            height: 20px;
            margin-top: 50px;
        }

        /* ================================================= */
        /* 3. Media Print (Kualitas Cetak) */
        /* ================================================= */
        @media print {
            body {
                background-color: white;
                padding: 0;
            }
            .kartu-biodata {
                box-shadow: none;
                margin: 0;
                border: none;
                min-height: auto;
            }
        }
    </style>
</head>
<body>

    <div id="loading" style="text-align: center; margin-top: 50px;">Memuat data dari Google Sheet. Mohon tunggu...</div>
    <div id="container-biodata">
        </div>

    <script>
        // ID Spreadsheet Anda (diambil dari URL)
        const SHEET_ID = '1eIcvIgCLWG3F9jQdsw5XN9llOsK2PoYWKUg1qaQJyyA';
        // URL untuk mengekspor sheet 'Form Responses 1' sebagai CSV
        const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Form Responses 1`; 
        
        const container = document.getElementById('container-biodata');
        const loading = document.getElementById('loading');

        // Fungsi utama untuk mengambil data
        async function fetchSheetData() {
            try {
                const response = await fetch(SHEET_URL);
                if (!response.ok) {
                    throw new Error(`Gagal mengambil data. Pastikan sheet 'Form Responses 1' tidak kosong dan link sudah di-share 'Anyone with the link'. Status: ${response.status}`);
                }
                const csvText = await response.text();
                loading.style.display = 'none';
                processCSV(csvText);
            } catch (error) {
                loading.innerText = '‼️ Error saat memuat data. Cek akses Google Sheet. Error: ' + error.message;
                console.error(error);
            }
        }

        // Fungsi untuk mengolah teks CSV menjadi objek JavaScript
        function processCSV(csvText) {
            // Memisahkan baris, lalu membersihkan baris kosong
            const rows = csvText.trim().split('\n').filter(row => row.trim().length > 0);
            if (rows.length < 2) {
                container.innerHTML = '<p style="text-align:center;">Tidak ada data ditemukan selain header.</p>';
                return;
            }

            // Memproses Header: membersihkan tanda kutip dan spasi
            const headers = rows[0].split(',').map(header => header.trim().replace(/"/g, ''));
            
            // Loop data mulai dari baris ke-2 (index 1)
            for (let i = 1; i < rows.length; i++) {
                // Regex split yang lebih kuat untuk mengatasi koma di dalam tanda kutip (CSV)
                const rowData = rows[i].match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || []; 
                
                let participant = {};
                rowData.forEach((value, index) => {
                    // Membersihkan nilai dari tanda kutip
                    participant[headers[index]] = value ? value.trim().replace(/"/g, '') : '';
                });

                // NO. URUT: Baris di Spreadsheet + 1 (Header = baris 1)
                participant['NO'] = i + 1; 

                createBiodataCard(participant);
            }
        }

        // Fungsi untuk membuat elemen HTML Kartu Biodata
        function createBiodataCard(data) {
            const kartu = document.createElement('div');
            kartu.className = 'kartu-biodata';

            // Mendapatkan dan membersihkan data
            const NAMA = data['Nama Lengkap (Sesuai Akta)'] || '-';
            const ABSEN = data['ID Pendaftaran'] || '-';
            const LEMBAGA = data['Asal Lembaga / TPQ'] || '-';
            const TEMPAT = data['Tempat Lahir'] || '';
            const TGL = data['Tanggal Lahir'] || '';
            const TTL_LENGKAP = (TEMPAT && TGL) ? `${TEMPAT}, ${TGL}` : '-';
            const BIN = data['Nama Ayah'] || '-';
            const BINTI = data['Nama Ibu'] || '-';
            const JK = data['Jenis Kelamin'] || '-';
            const FOTO_URL = data['Kirim Pas Foto Ukuran PostCard'] || '';

            // 1. Header
            kartu.innerHTML = `
                <div class="header">
                    <h2>KARTU BIODATA PESERTA EBTAQ</h2>
                    <p>ASAL LEMBAGA: ${LEMBAGA.toUpperCase()}</p>
                </div>
            `;

            // 2. Data Grid (Menggantikan layout Biodata Cek.docm)
            const grid = document.createElement('div');
            grid.className = 'data-grid';
            
            // Kolom Data
            const dataFields = [
                { label: 'NO.', value: data['NO'] }, // Sesuai permintaan: Row Index
                { label: 'NO. ABSEN', value: ABSEN }, // Menggantikan {{ABSEN}}
                { label: 'NAMA LENGKAP', value: NAMA.toUpperCase() }, // Menggantikan {{NAMA_PESERTA}}
                { label: 'T.T.L.', value: TTL_LENGKAP }, // Menggantikan {{TTL_LENGKAP}}
                { label: 'JENIS KELAMIN', value: JK }, // Menggantikan {{JK}}
                { label: 'BIN', value: BIN.toUpperCase() }, // Menggantikan {{BIN}}
                { label: 'BINTI', value: BINTI.toUpperCase() }, // Menggantikan {{BINTI}}
            ];

            dataFields.forEach(field => {
                // Menambahkan elemen label dan nilai
                grid.innerHTML += `<span class="label">${field.label}</span><span class="value">: ${field.value}</span>`;
            });
            
            // Kolom Foto (Menggantikan {{FOTO_PESERTA}})
            grid.innerHTML += `
                <div class="foto-container">
                    <img src="${FOTO_URL}" alt="Foto Peserta" 
                         onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'100\\' height=\\'130\\'><rect width=\\'100\\'% height=\\'100\\'% fill=\\'#eee\\' stroke=\\'#aaa\\'/><text x=\\'50\\' y=\\'65\\' font-size=\\'10\\' text-anchor=\\'middle\\' fill=\\'#777\\'>FOTO GAGAL</text></svg>'"
                    >
                    <p class="foto-label">3x4</p>
                </div>
            `;

            kartu.appendChild(grid);
            
            // 3. Area Tanda Tangan (TTD)
            kartu.innerHTML += `
                <div class="ttd-area">
                    <div>
                        <p>Demak, ${new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}</p>
                        <p>Tanda Tangan Peserta</p>
                        <div class="ttd-placeholder"></div>
                        <p style="margin-top: 5px;">( ${NAMA.toUpperCase()} )</p>
                    </div>
                </div>
            `;

            container.appendChild(kartu);
        }

        fetchSheetData();
    </script>
</body>
</html>