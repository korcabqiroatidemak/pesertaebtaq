<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CODE X – Cetak Kartu Peserta</title>

<style>
/* ================= PAGE SETUP ================= */
@page{
    size: 215mm 330mm; /* F4 */
    margin: 10mm;
}
body{
    font-family:"Times New Roman", Times, serif;
    background:#eee;
    margin:0;
}

/* ================= PANEL KONTROL ================= */
#control-panel{
    background:#fff;
    padding:12px;
    margin:10px auto;
    max-width:900px;
    border:1px solid #ccc;
}
#shift-container{
    margin-top:8px;
    border:1px solid #ddd;
    padding:10px;
    display:grid;
    grid-template-rows:repeat(3,auto); /* 3 BARIS */
    grid-auto-flow:column;
    gap:8px 30px;
    overflow-x:auto;
    max-height:90px;
}
#control-panel button{
    margin-top:10px;
    padding:6px 14px;
}

/* ================= PAGE CONTAINER ================= */
.page-container{
    width:215mm;
    height:330mm;
    background:#fff;
    margin:10px auto;
    box-sizing:border-box;
    page-break-after:always;
    padding:6mm;
    display:flex;
    flex-direction:column;
}

/* ================= HEADER ================= */
.header{
    text-align:center;
    border-bottom:2px solid #000;
    padding-bottom:6px;
    margin-bottom:6px;
}
.header h2{
    margin:0;
    font-size:14pt;
}
.header .sub{
    font-size:11pt;
}

/* ================= GRID ================= */
.card-grid{
    flex:1;
    display:grid;
    gap:6px;
}
.first-page .card-grid{
    grid-template-columns:1fr 1fr;
    grid-template-rows:repeat(5,1fr); /* 2×5 */
}
.next-page .card-grid{
    grid-template-columns:1fr 1fr;
    grid-template-rows:repeat(6,1fr); /* 2×6 */
}

/* ================= CARD ================= */
.kartu{
    border:1px solid #000;
    padding:5px;
    font-size:10pt;
    display:flex;
}
.foto{
    width:3cm;
    height:4cm;
    margin-right:6px;
    border:1px solid #ccc;
    flex-shrink:0;
}
.foto img{
    width:100%;
    height:100%;
    object-fit:cover;
}
.info{
    flex:1;
}
.row{
    display:flex;
    margin-bottom:2px;
}
.label{
    width:65px;
    font-weight:bold;
}
.sep{
    width:10px;
}
.value{
    flex:1;
    word-wrap:break-word;
}

/* ================= FOOTER ================= */
.next-page{
    position:relative;
}
.footer-info{
    position:absolute;
    bottom:6mm;
    right:8mm;
    font-size:9pt;
    color:#555;
}

/* ================= PRINT ================= */
@media print{
    body{background:#fff;}
    #control-panel{display:none;}
}
</style>
</head>

<body>

<!-- ============ PANEL KONTROL ============ -->
<div id="control-panel">
    <b>Pilih Gelombang – Shift</b>
    <div id="shift-container"></div>
    <button onclick="generate()">Generate</button>
</div>

<div id="output"></div>

<script>
/* ================= DATA SOURCE ================= */
const SHEET_ID = '1eIcvIgCLWG3F9jQdsw5XN9llOsK2PoYWKUg1qaQJyyA';
const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Biodata Cek`;

let rawData=[];

/* ================= FETCH ================= */
fetch(SHEET_URL)
.then(r=>r.text())
.then(csv=>{
    const rows=csv.trim().split('\n');
    const headers=rows[0].split(',').map(h=>h.replace(/"/g,''));
    for(let i=1;i<rows.length;i++){
        const cols=rows[i].match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
        let obj={};
        headers.forEach((h,idx)=>{
            obj[h]=cols[idx]?cols[idx].replace(/"/g,''):'';
        });
        rawData.push(obj);
    }
    buildShiftPanel();
});

/* ================= PANEL ================= */
function buildShiftPanel(){
    const box=document.getElementById('shift-container');
    const set=new Set();
    rawData.forEach(d=>{
        if(d.Gelombang && d.Shift){
            set.add(`${d.Gelombang}-${d.Shift}`);
        }
    });
    [...set].sort().forEach(v=>{
        const lbl=document.createElement('label');
        lbl.innerHTML=`<input type="checkbox" value="${v}"> Gel ${v.replace('-', ' - Shift ')}`;
        box.appendChild(lbl);
    });
}

/* ================= GENERATE ================= */
function generate(){
    const output=document.getElementById('output');
    output.innerHTML='';

    document.querySelectorAll('#shift-container input:checked')
    .forEach(cb=>{
        const [gel,shift]=cb.value.split('-');
        const data=rawData
            .filter(d=>d.Gelombang==gel && d.Shift==shift)
            .sort((a,b)=>Number(a.Nomor)-Number(b.Nomor));

        renderShift(output,data,gel,shift);
    });
}

/* ================= RENDER SHIFT ================= */
function renderShift(output,data,gel,shift){
    if(!data.length) return;

    let page=createFirstPage(gel,shift);
    let count=0;

    data.forEach((d,i)=>{
        const limit = page.classList.contains('first-page') ? 10 : 12;
        if(count===limit){
            output.appendChild(page);
            page=createNextPage(gel,shift);
            count=0;
        }
        page.querySelector('.card-grid').appendChild(createCard(d));
        count++;
    });
    output.appendChild(page);
}

/* ================= PAGE ================= */
function createFirstPage(gel,shift){
    const div=document.createElement('div');
    div.className='page-container first-page';
    div.innerHTML=`
        <div class="header">
            <h2>DAFTAR PESERTA</h2>
            <div class="sub">Rojab 1447 | Gel ${gel} - Shift ${shift}</div>
        </div>
        <div class="card-grid"></div>
    `;
    return div;
}

function createNextPage(gel,shift){
    const div=document.createElement('div');
    div.className='page-container next-page';
    div.innerHTML=`
        <div class="card-grid"></div>
        <div class="footer-info">Rojab 1447 | Gel ${gel} - Shift ${shift}</div>
    `;
    return div;
}

/* ================= CARD ================= */
function createCard(d){
    const c=document.createElement('div');
    c.className='kartu';

    const no=String(d.Nomor||'').padStart(3,'0');
    const foto=d['Kirim Pas Foto Ukuran PostCard']||'';

    c.innerHTML=`
        <div class="foto">
            <img src="${foto}" onerror="this.style.display='none'">
        </div>
        <div class="info">
            <div class="row"><span class="label">Nomor</span><span class="sep">:</span><span class="value">${no}</span></div>
            <div class="row"><span class="label">Nama</span><span class="sep">:</span><span class="value"><b>${(d['Nama Lengkap (Sesuai Akta)']||'').toUpperCase()}</b></span></div>
            <div class="row"><span class="label">TTL</span><span class="sep">:</span><span class="value">${d['Tempat Lahir']||''}, ${d['Tanggal Lahir']||''}</span></div>
            <div class="row"><span class="label">JK</span><span class="sep">:</span><span class="value">${d['Jenis Kelamin']||''}</span></div>
            <div class="row"><span class="label">BIN</span><span class="sep">:</span><span class="value">${(d['Nama Ayah']||'').toUpperCase()}</span></div>
            <div class="row"><span class="label">BINTI</span><span class="sep">:</span><span class="value">${(d['Nama Ibu']||'').toUpperCase()}</span></div>
        </div>
    `;
    return c;
}
</script>

</body>
</html>
